#!/bin/bash

# vim: set ts=4 sw=4:

if [ "$SSH_ORIGINAL_COMMAND" != "" ]; then
    # $SSH_ORIGINAL_COMMAND has quoting; split it apart into arguments
    eval "set $SSH_ORIGINAL_COMMAND"
    COMMAND=$1
    shift

    case "$COMMAND" in
	create-repository)
	    exec /home/admin/gitadmin-bin/create-repository "$@"
	    ;;

	finish-import)
	    exec /home/admin/gitadmin-bin/finish-import "$@"
	    ;;

	# These allow 'git push --exec=force/import'
	force)
	    exec /home/admin/gitadmin-bin/receive-pack-force "$@"
	    ;;

	import)
	    exec /home/admin/gitadmin-bin/receive-pack-import "$@"
	    ;;

# This existed for retrieving mango passwords from svn.gnome.org; if we keep the
# system and repurpose socket for something else we could move the files to
# git.gnome.org, but it's a bit of a wonky system.
#	mango)
#	    cat "/var/local/mango/`whoami`" 2> /dev/null
#	    echo > "/var/local/mango/`whoami`" 2> /dev/null
#	    exit
#	    ;;
	*)
	    exec /usr/bin/git-shell -c "$SSH_ORIGINAL_COMMAND"
	    ;;
    esac
fi

echo 'SSH authentication succeeded. Interactive login is not allowed.'
exit 1
