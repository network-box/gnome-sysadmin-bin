#!/bin/bash

REPOS="$1"
DUMPFILE="$2"

SVNROOT=/svn
CHECK=$(echo "$REPOS" | sed 's/[-a-z]//g')

if [ -n "$CHECK" -o -z "$REPOS" ]; then
	echo Usage: $0 REPOS [DUMPFILE]
	echo Make sure REPOS only contains lower case characters
	exit 1
fi

if [ -d $SVNROOT/$REPOS ]; then
	echo Repository $REPOS already exists!
	exit 1
fi

if [ -n "$DUMPFILE" -a ! -r "$DUMPFILE" ]; then
	echo Dumpfile $DUMPFILE is not readable!
	exit 1
fi

svnadmin create $SVNROOT/$REPOS
if [ $? -ne 0 ]; then
	echo ERROR: after svnadmin create
	exit 1
fi

# Setup hooks
cat > $SVNROOT/$REPOS/hooks/post-commit <<__EOF__
#!/bin/sh

REPOS="\$1"
REV="\$2"

# Run the system-wide post-commit check
/svn/bin/common-post-commit \$REPOS \$REV
__EOF__
chmod 755 $SVNROOT/$REPOS/hooks/post-commit

cat > $SVNROOT/$REPOS/hooks/pre-commit <<__EOF__
#!/bin/sh

REPOS="\$1"
TXN="\$2"

# Run the system-wide pre-commit check
/svn/bin/common-pre-commit \$REPOS \$TXN
__EOF__
chmod 755 $SVNROOT/$REPOS/hooks/pre-commit

# Correct permissions
chown -R gnomecvs:gnomecvs $SVNROOT/$REPOS
chmod -R ug+ws $SVNROOT/$REPOS

# Now load the dump if we have one
if [ -n "$DUMPFILE" ]; then
	if [ "${DUMPFILE%.gz}" != "$DUMPFILE" ]; then
		zcat "$DUMPFILE" | svnadmin load $SVNROOT/$REPOS --quiet
		err=$?
	elif [ "${DUMPFILE%.bz2}" != "$DUMPFILE" ]; then
		bzcat "$DUMPFILE" | svnadmin load $SVNROOT/$REPOS --quiet
		err=$?
	else
		cat "$DUMPFILE" | svnadmin load $SVNROOT/$REPOS --quiet
		err=$?
	fi

	if [ $err -ne 0 ]; then
		echo ERROR: Could not load the dump file $DUMPFILE!
		exit 1
	fi

else
	svn mkdir -m "Initial project roots" file://$SVNROOT/$REPOS/{trunk,branches,tags}
fi

# Rebuild 'bonsai' database
/var/www/viewcvs-web/bin/svndbadmin rebuild $SVNROOT/$REPOS




