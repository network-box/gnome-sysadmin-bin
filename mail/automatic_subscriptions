# This script will periodically check the foundation_db and automatically
# subscribe new Foundation members to the relevant mailing lists. (foundation-announce)
# Author: Andrea Veri <av@gnome.org>

WORKDIR="/var/cache"
QUERY='SELECT email from foundationmembers WHERE TO_DAYS(last_renewed_on)=To_DAYS(NOW()); SELECT email from foundationmembers WHERE TO_DAYS(first_added)=To_DAYS(NOW())'
PASSWORD="`grep mysql_password /home/admin/secret/anonvoting | sed -r 's/^[^"]+"//;s/"[^#]+//'`"

mysql -N -r -h button-back --user=anonvoting --password="$PASSWORD" -e "$QUERY" foundation > $WORKDIR/new_foundation_members

if [ -s "${WORKDIR}/new_foundation_members" ]; then
    cd $WORKDIR
    /usr/lib/mailman/bin/add_members -a n -r new_foundation_members foundation-announce
    rm -rf $WORKDIR/new_foundation_members
else
    exit 1
fi

